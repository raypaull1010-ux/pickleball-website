<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Panel - Ray's Pickleball</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- Email Service Module -->
    <script src="js/email-service.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- API Client -->
    <script src="js/api-client.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="index.html">Admin Panel</a>
            </div>
        </nav>
    </header>

    <main>
        <section class="page-header">
            <h1>Payment Confirmation Panel</h1>
            <p>Manage pending orders and send payment confirmation emails</p>
        </section>

        <section class="contact-content">
            <div class="container">
                <div class="admin-container">

                    <!-- Authentication Section -->
                    <div id="authSection" class="auth-section">
                        <div class="auth-box">
                            <h2>Admin Access</h2>
                            <p>Sign in with your admin account</p>

                            <!-- Supabase Login Form -->
                            <div id="supabaseLoginForm">
                                <div class="form-group">
                                    <label for="adminEmail">Email</label>
                                    <input type="email" id="adminEmail" class="admin-input" placeholder="admin@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="adminPassword">Password</label>
                                    <input type="password" id="adminPassword" class="admin-input" placeholder="Enter password">
                                </div>
                                <button class="btn btn-primary btn-full" onclick="supabaseLogin()">Sign In</button>
                                <p style="text-align: center; margin-top: 12px; color: var(--text-light); font-size: 14px;">
                                    <a href="#" onclick="showLegacyLogin(); return false;">Use legacy password</a>
                                </p>
                            </div>

                            <!-- Legacy Password Form (fallback) -->
                            <div id="legacyLoginForm" style="display: none;">
                                <div class="form-group">
                                    <label for="legacyPassword">Password</label>
                                    <input type="password" id="legacyPassword" class="admin-input" placeholder="Enter password">
                                </div>
                                <button class="btn btn-primary btn-full" onclick="checkPassword()">Access Panel</button>
                                <p style="text-align: center; margin-top: 12px; color: var(--text-light); font-size: 14px;">
                                    <a href="#" onclick="showSupabaseLogin(); return false;">Use Supabase login</a>
                                </p>
                            </div>

                            <div id="authError" style="display: none; color: #dc2626; margin-top: 12px; padding: 8px; background: #fef2f2; border-radius: 4px;"></div>
                        </div>
                    </div>

                    <!-- Admin Dashboard (hidden by default) -->
                    <div id="adminDashboard" style="display: none;">

                        <!-- Stats Overview -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="pendingVideoCount">0</div>
                                <div class="stat-label">Pending Video Orders</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="pendingMemberCount">0</div>
                                <div class="stat-label">Pending Memberships</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalConfirmedCount">0</div>
                                <div class="stat-label">Total Confirmed</div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="admin-tabs">
                            <button class="tab-btn active" data-tab="videos">Video Submissions</button>
                            <button class="tab-btn" data-tab="memberships">Memberships</button>
                            <button class="tab-btn" data-tab="referrals">Referrals</button>
                            <button class="tab-btn" data-tab="instructors">Instructors</button>
                            <button class="tab-btn" data-tab="evaluations">Evaluations</button>
                            <button class="tab-btn" data-tab="history">History</button>
                            <button class="tab-btn" data-tab="badges">Badges</button>
                        </div>

                        <!-- Video Submissions Tab -->
                        <div id="videosTab" class="tab-content active">
                            <h3>Pending Video Submissions</h3>
                            <p class="tab-description">Verify Venmo payment, then click "Confirm Payment" to send confirmation email.</p>
                            <div id="pendingVideosList" class="orders-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Memberships Tab -->
                        <div id="membershipsTab" class="tab-content" style="display: none;">
                            <h3>Pending Membership Requests</h3>
                            <p class="tab-description">Verify Venmo payment, then click "Activate Membership" to send welcome email.</p>
                            <div id="pendingMembersList" class="orders-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Referrals Tab -->
                        <div id="referralsTab" class="tab-content" style="display: none;">
                            <h3>Referral Rewards Management</h3>
                            <p class="tab-description">View referral stats and mark rewards as claimed.</p>

                            <!-- Referral Stats Summary -->
                            <div class="referral-stats-grid">
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="totalReferralsCount">0</span>
                                    <span class="ref-stat-label">Total Referrals</span>
                                </div>
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="pendingReferralsCount">0</span>
                                    <span class="ref-stat-label">Pending (30 days)</span>
                                </div>
                                <div class="ref-stat-box ambassador-stat">
                                    <span class="ref-stat-value" id="ambassadorCount">0</span>
                                    <span class="ref-stat-label">Ambassadors</span>
                                </div>
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="unclaimedRewardsCount">0</span>
                                    <span class="ref-stat-label">Unclaimed Rewards</span>
                                </div>
                            </div>

                            <!-- Unclaimed Rewards -->
                            <div class="admin-section">
                                <h4>üéÅ Rewards Ready to Claim</h4>
                                <div id="unclaimedRewardsList" class="rewards-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Ambassadors List -->
                            <div class="admin-section">
                                <h4>‚≠ê Ambassadors</h4>
                                <div id="ambassadorsList" class="ambassadors-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- All Referrers -->
                            <div class="admin-section">
                                <h4>üìä All Member Referrals</h4>
                                <div id="allReferralsList" class="all-referrals-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Instructors Tab -->
                        <div id="instructorsTab" class="tab-content" style="display: none;">
                            <h3>Instructor Network Management</h3>
                            <p class="tab-description">Manage instructor profiles, track referrals, and handle payments.</p>

                            <!-- Instructor Stats Summary -->
                            <div class="referral-stats-grid">
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="totalInstructorsCount">0</span>
                                    <span class="ref-stat-label">Total Instructors</span>
                                </div>
                                <div class="ref-stat-box" style="background: #ecfdf5; border-color: #10b981;">
                                    <span class="ref-stat-value" id="activeInstructorsCount" style="color: #059669;">0</span>
                                    <span class="ref-stat-label">Active</span>
                                </div>
                                <div class="ref-stat-box" style="background: #fef3c7; border-color: #f59e0b;">
                                    <span class="ref-stat-value" id="graceInstructorsCount" style="color: #b45309;">0</span>
                                    <span class="ref-stat-label">In Grace Period</span>
                                </div>
                                <div class="ref-stat-box" style="background: #fef2f2; border-color: #ef4444;">
                                    <span class="ref-stat-value" id="pausedInstructorsCount" style="color: #dc2626;">0</span>
                                    <span class="ref-stat-label">Paused</span>
                                </div>
                            </div>

                            <!-- Refer Student to Instructor -->
                            <div class="admin-section" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981;">
                                <h4>ü§ù Refer a Student to an Instructor</h4>
                                <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 15px;">When you recommend an instructor to a student, log it here to track two-way referrals.</p>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">Student Name</label>
                                        <input type="text" id="referStudentName" placeholder="Student's name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">Referred to Instructor</label>
                                        <select id="referToInstructor" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                            <option value="">Select instructor...</option>
                                        </select>
                                    </div>
                                    <button onclick="logRayReferral()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">Log Referral</button>
                                </div>
                            </div>

                            <!-- Instructors Needing Attention -->
                            <div class="admin-section">
                                <h4>‚ö†Ô∏è Needs Attention (Grace Period Ending Soon)</h4>
                                <div id="instructorsNeedingAttention" class="instructor-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- All Instructors -->
                            <div class="admin-section">
                                <h4>üë• All Instructors</h4>
                                <div id="allInstructorsList" class="instructor-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Evaluations Tab -->
                        <div id="evaluationsTab" class="tab-content" style="display: none;">
                            <h3>Skill Level Evaluations</h3>
                            <p class="tab-description">Review video submissions, input evaluations, and send results to customers.</p>

                            <!-- Evaluation Stats Summary -->
                            <div class="referral-stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="pendingEvalsCount">0</span>
                                    <span class="ref-stat-label">Pending Evaluations</span>
                                </div>
                                <div class="ref-stat-box" style="background: #fef3c7; border-color: #f59e0b;">
                                    <span class="ref-stat-value" id="awaitingPaymentCount" style="color: #b45309;">0</span>
                                    <span class="ref-stat-label">Awaiting Payment</span>
                                </div>
                                <div class="ref-stat-box" style="background: #ecfdf5; border-color: #10b981;">
                                    <span class="ref-stat-value" id="completedEvalsCount" style="color: #059669;">0</span>
                                    <span class="ref-stat-label">Completed</span>
                                </div>
                            </div>

                            <!-- Pending Evaluations -->
                            <div class="admin-section">
                                <h4>üìã Pending Evaluations (Payment Confirmed)</h4>
                                <div id="pendingEvalsList" class="orders-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Awaiting Payment -->
                            <div class="admin-section">
                                <h4>üí≥ Awaiting Payment Confirmation</h4>
                                <div id="awaitingPaymentList" class="orders-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Completed Evaluations -->
                            <div class="admin-section">
                                <h4>‚úÖ Recently Completed</h4>
                                <div id="completedEvalsList" class="orders-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Evaluation Modal -->
                        <div id="evalModal" class="eval-modal-overlay" style="display: none;">
                            <div class="eval-modal-content">
                                <button class="modal-close-btn" onclick="closeEvalModal()">&times;</button>
                                <h3>Complete Evaluation</h3>
                                <p id="evalModalCustomer" style="color: var(--text-light); margin-bottom: 20px;"></p>

                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Skill Level</label>
                                    <select id="evalLevel" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                                        <option value="">Select level...</option>
                                        <option value="2.5">2.5 - Beginner</option>
                                        <option value="3.0">3.0 - Novice</option>
                                        <option value="3.25">3.25 - Low Intermediate</option>
                                        <option value="3.5">3.5 - Intermediate</option>
                                        <option value="3.75">3.75 - High Intermediate</option>
                                        <option value="4.0">4.0 - Advanced</option>
                                        <option value="4.25">4.25 - Low Expert</option>
                                        <option value="4.5">4.5 - Expert</option>
                                        <option value="4.75">4.75 - High Expert</option>
                                        <option value="5.0+">5.0+ - Pro Level</option>
                                    </select>
                                </div>

                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Evaluation Summary</label>
                                    <textarea id="evalSummary" rows="8" placeholder="Write your evaluation here... Include strengths, areas for improvement, and explanation of the rating." style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-secondary" onclick="closeEvalModal()">Cancel</button>
                                    <button class="btn-confirm" onclick="submitEvaluation()">Send Evaluation</button>
                                </div>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div id="historyTab" class="tab-content" style="display: none;">
                            <h3>Confirmation History</h3>
                            <p class="tab-description">Recently confirmed payments and activated memberships.</p>
                            <div id="historyList" class="orders-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Badges Tab -->
                        <div id="badgesTab" class="tab-content" style="display: none;">
                            <h3>Badge Management</h3>
                            <p class="tab-description">View, add, edit, and delete badges. All changes save directly to the database.</p>

                            <!-- Badge Stats -->
                            <div class="referral-stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                                <div class="ref-stat-box">
                                    <span class="ref-stat-value" id="badgeTotalCount">0</span>
                                    <span class="ref-stat-label">Total Badges</span>
                                </div>
                                <div class="ref-stat-box" style="background: #ecfdf5; border-color: #10b981;">
                                    <span class="ref-stat-value" id="badgeCategoryCount" style="color: #059669;">0</span>
                                    <span class="ref-stat-label">Categories</span>
                                </div>
                                <div class="ref-stat-box" style="background: #ede9fe; border-color: #8b5cf6;">
                                    <span class="ref-stat-value" id="badgeRareCount" style="color: #7c3aed;">0</span>
                                    <span class="ref-stat-label">Rare+</span>
                                </div>
                                <div class="ref-stat-box" style="background: #fef3c7; border-color: #f59e0b;">
                                    <span class="ref-stat-value" id="badgeHiddenCount" style="color: #b45309;">0</span>
                                    <span class="ref-stat-label">Hidden</span>
                                </div>
                            </div>

                            <!-- Badge Filters -->
                            <div class="badge-filter-bar">
                                <input type="text" id="badgeSearchInput" placeholder="Search badges..." oninput="filterBadgesAdmin()">
                                <select id="badgeCategoryFilter" onchange="filterBadgesAdmin()">
                                    <option value="">All Categories</option>
                                </select>
                                <select id="badgeRarityFilter" onchange="filterBadgesAdmin()">
                                    <option value="">All Rarities</option>
                                    <option value="common">Common</option>
                                    <option value="uncommon">Uncommon</option>
                                    <option value="rare">Rare</option>
                                    <option value="epic">Epic</option>
                                    <option value="legendary">Legendary</option>
                                </select>
                                <button class="btn btn-primary" onclick="openBadgeModal()">+ Add Badge</button>
                            </div>

                            <!-- Badge Grid -->
                            <div class="admin-badges-grid" id="adminBadgesGrid">
                                <div class="loading">Loading badges...</div>
                            </div>
                        </div>

                        <!-- Badge Add/Edit Modal -->
                        <div id="badgeModal" class="eval-modal-overlay" style="display: none;">
                            <div class="eval-modal-content">
                                <button class="modal-close-btn" onclick="closeBadgeModal()">&times;</button>
                                <h3 id="badgeModalTitle">Add Badge</h3>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Badge ID</label>
                                        <input type="text" id="badgeFormId" placeholder="e.g. streak-streak-200" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Icon (Emoji)</label>
                                        <input type="text" id="badgeFormIcon" placeholder="e.g. üèÜ" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Name</label>
                                        <input type="text" id="badgeFormName" placeholder="Badge name" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Description</label>
                                        <input type="text" id="badgeFormDesc" placeholder="Short description" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Category</label>
                                        <select id="badgeFormCategory" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                            <option value="streak">streak</option>
                                            <option value="challenge">challenge</option>
                                            <option value="contest">contest</option>
                                            <option value="points">points</option>
                                            <option value="social">social</option>
                                            <option value="drills">drills</option>
                                            <option value="time">time</option>
                                            <option value="special">special</option>
                                            <option value="leaderboard">leaderboard</option>
                                            <option value="featured">featured</option>
                                            <option value="helper">helper</option>
                                            <option value="skill">skill</option>
                                            <option value="combo">combo</option>
                                            <option value="member">member</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Requirement Type</label>
                                        <input type="text" id="badgeFormReqType" placeholder="e.g. count, streak, milestone, special" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Requirement Value</label>
                                        <input type="number" id="badgeFormReqValue" placeholder="1" step="any" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Requirement Action</label>
                                        <input type="text" id="badgeFormReqAction" placeholder="e.g. streak, completed, wins" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Rarity</label>
                                        <select id="badgeFormRarity" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                            <option value="common">common</option>
                                            <option value="uncommon">uncommon</option>
                                            <option value="rare">rare</option>
                                            <option value="epic">epic</option>
                                            <option value="legendary">legendary</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">XP Reward</label>
                                        <input type="number" id="badgeFormXP" placeholder="0" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="badgeFormHidden">
                                        <span style="font-weight: 600;">Hidden Badge</span>
                                        <span style="color: var(--text-light); font-size: 0.85rem;">(Secret badge not shown until earned)</span>
                                    </label>
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                    <button class="btn btn-secondary" onclick="closeBadgeModal()">Cancel</button>
                                    <button class="btn-confirm" onclick="saveBadge()">Save Badge</button>
                                </div>
                            </div>
                        </div>

                        <!-- Status Message -->
                        <div id="statusMessage" class="status-message" style="display: none;"></div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Ray Paull Pickleball Analysis. Admin Panel.</p>
        </div>
    </footer>

    <style>
        /* Admin Container */
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Auth Section */
        .auth-section {
            display: flex;
            justify-content: center;
            padding: 40px 0;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .auth-box h2 {
            margin-bottom: 10px;
        }

        .auth-box > p {
            color: var(--text-light);
            margin-bottom: 25px;
        }

        .admin-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--background-alt);
            color: var(--text-color);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .tab-content h3 {
            margin-bottom: 5px;
        }

        .tab-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* Orders List */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-card {
            background: var(--background-alt);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .order-customer {
            display: flex;
            flex-direction: column;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .customer-email {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .order-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .order-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .detail-value {
            color: var(--text-color);
            font-weight: 500;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .btn-confirm {
            background: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-confirm:hover {
            background: #059669;
        }

        .btn-confirm:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-view-video {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            text-decoration: none;
        }

        .btn-view-video:hover {
            background: #1d4ed8;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* History Item */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--background-alt);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .history-info {
            display: flex;
            flex-direction: column;
        }

        .history-type {
            font-size: 0.8rem;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .history-name {
            font-weight: 600;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Referrals Tab Styles */
        .referral-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .ref-stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .ref-stat-box.ambassador-stat {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .ref-stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .ambassador-stat .ref-stat-value {
            color: #b45309;
        }

        .ref-stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .admin-section h4 {
            margin-bottom: 15px;
            color: var(--text-color);
        }

        /* Reward Claim Cards */
        .reward-claim-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #fbbf24;
            flex-wrap: wrap;
            gap: 10px;
        }

        .reward-member-info {
            display: flex;
            flex-direction: column;
        }

        .reward-member-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .reward-member-email {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .reward-info {
            text-align: center;
        }

        .reward-tier-badge {
            display: block;
            font-size: 0.75rem;
            color: #92400e;
            background: rgba(255,255,255,0.5);
            padding: 2px 8px;
            border-radius: 10px;
            margin-bottom: 3px;
        }

        .reward-name {
            font-weight: 600;
            color: #b45309;
        }

        .btn-claim {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-claim:hover {
            background: #059669;
        }

        /* Ambassador Cards */
        .ambassador-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #fef3c7 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #f59e0b;
        }

        .ambassador-info {
            display: flex;
            flex-direction: column;
        }

        .ambassador-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .ambassador-email {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .ambassador-stats {
            text-align: right;
            font-size: 0.85rem;
            color: #78350f;
        }

        .ambassador-badge-small {
            background: linear-gradient(135deg, #fbbf24, #8b5cf6);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* All Referrals List */
        .referral-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--background-alt);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .referrer-name {
            font-weight: 500;
        }

        .referral-count {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Responsive for referrals */
        @media (max-width: 768px) {
            .referral-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .reward-claim-card {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Instructor Cards */
        .instructor-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .instructor-admin-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--background-alt);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .instructor-admin-card.grace-ending {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .instructor-admin-card.paused {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .instructor-admin-info {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .instructor-admin-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .instructor-admin-email {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .instructor-admin-location {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .instructor-admin-stats {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
        }

        .inst-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .inst-stat-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        .inst-stat-label {
            color: var(--text-light);
            font-size: 0.75rem;
        }

        .instructor-admin-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #059669;
        }

        .status-badge.paused {
            background: #fecaca;
            color: #dc2626;
        }

        .status-badge.grace {
            background: #fde68a;
            color: #b45309;
        }

        .grace-countdown {
            font-size: 0.8rem;
            color: #b45309;
        }

        .instructor-admin-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-small.activate {
            background: #10b981;
            color: white;
        }

        .btn-small.pause {
            background: #f59e0b;
            color: white;
        }

        .btn-small.view {
            background: var(--primary-color);
            color: white;
        }

        /* Evaluation Modal */
        .eval-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .eval-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--background-alt);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Evaluation Cards */
        .eval-card {
            background: var(--background-alt);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .eval-card.awaiting-payment {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .eval-card.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .eval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .eval-customer-info {
            display: flex;
            flex-direction: column;
        }

        .eval-customer-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .eval-customer-email {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .eval-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .eval-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .eval-detail-item {
            display: flex;
            flex-direction: column;
        }

        .eval-detail-label {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .eval-detail-value {
            color: var(--text-color);
            font-weight: 500;
        }

        .eval-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .eval-result-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #10b981;
        }

        .eval-result-level {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .eval-result-summary {
            color: var(--text-color);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Status Message */
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Data source indicator */
        .data-source-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: var(--background-alt);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-light);
            z-index: 100;
        }

        .data-source-badge.database {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-wrap: wrap;
            }

            .order-header {
                flex-direction: column;
                gap: 10px;
            }

            .order-actions {
                flex-direction: column;
            }
        }

        /* Badge Admin Styles */
        .badge-filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
            align-items: center;
        }
        .badge-filter-bar input,
        .badge-filter-bar select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .badge-filter-bar input { flex: 1; min-width: 180px; }

        .admin-badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .admin-badge-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .admin-badge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .admin-badge-card.rarity-uncommon { border-color: #10b981; }
        .admin-badge-card.rarity-rare { border-color: #3b82f6; }
        .admin-badge-card.rarity-epic { border-color: #8b5cf6; }
        .admin-badge-card.rarity-legendary { border-color: #f59e0b; }
        .admin-badge-card.is-hidden { opacity: 0.7; }

        .admin-badge-icon { font-size: 2rem; flex-shrink: 0; line-height: 1; }
        .admin-badge-info { flex: 1; min-width: 0; }
        .admin-badge-name { font-weight: 600; font-size: 0.95rem; display: block; }
        .admin-badge-desc { font-size: 0.8rem; color: var(--text-light); display: block; margin-top: 2px; }

        .admin-badge-meta {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .badge-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        .badge-tag.cat-tag { background: #f3f4f6; color: #4b5563; }
        .badge-tag.type-tag { background: #dbeafe; color: #1d4ed8; }
        .badge-tag.rarity-common { background: #e5e7eb; color: #6b7280; }
        .badge-tag.rarity-uncommon { background: #d1fae5; color: #059669; }
        .badge-tag.rarity-rare { background: #dbeafe; color: #2563eb; }
        .badge-tag.rarity-epic { background: #ede9fe; color: #7c3aed; }
        .badge-tag.rarity-legendary { background: #fef3c7; color: #b45309; }
        .badge-tag.hidden-tag { background: #fecaca; color: #dc2626; }

        .admin-badge-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .btn-icon {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .btn-icon:hover { background: #f3f4f6; }
        .btn-icon.btn-danger:hover { background: #fef2f2; color: #dc2626; border-color: #fca5a5; }

        .badge-count-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
        }
    </style>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Use shared config from js/config.js
        const SUPABASE_URL = CONFIG.SUPABASE_URL;
        const SUPABASE_ANON_KEY = CONFIG.SUPABASE_ANON_KEY;

        // Legacy password (keep for fallback during transition)
        // NOTE: This should be removed once Supabase auth is fully configured
        const ADMIN_PASSWORD = CONFIG.LEGACY_ADMIN_PASSWORD || 'raycoach2025';

        // Initialize Supabase client
        let supabase = null;
        let currentUser = null;
        let useSupabase = false;
        let authToken = null; // For API calls

        if (CONFIG.isSupabaseConfigured()) {
            supabase = getSupabaseClient();
            useSupabase = true;
        }

        // ============================================
        // AUTHENTICATION
        // ============================================

        // Check if already logged in
        async function checkExistingSession() {
            if (!supabase) return;

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // Store auth token for API calls
                authToken = session.access_token;

                // Verify user is admin
                const { data: userData } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', session.user.id)
                    .single();

                if (userData?.role === 'admin') {
                    currentUser = session.user;
                    showAdminDashboard();
                }
            }
        }

        // Check on page load
        checkExistingSession();

        // Supabase login
        async function supabaseLogin() {
            if (!supabase) {
                showAuthError('Supabase not configured. Use legacy password.');
                return;
            }

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showAuthError('Please enter email and password.');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                // Verify user is admin
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', data.user.id)
                    .single();

                if (userError || userData?.role !== 'admin') {
                    await supabase.auth.signOut();
                    showAuthError('Access denied. Admin privileges required.');
                    return;
                }

                // Store auth token for API calls
                authToken = data.session.access_token;
                currentUser = data.user;
                showAdminDashboard();

            } catch (error) {
                showAuthError(error.message || 'Login failed.');
            }
        }

        // Legacy password check (fallback)
        function checkPassword() {
            const entered = document.getElementById('legacyPassword').value;
            if (entered === ADMIN_PASSWORD) {
                console.warn('Using legacy authentication. Please migrate to Supabase auth.');
                showAdminDashboard();
            } else {
                showAuthError('Incorrect password');
            }
        }

        function showAdminDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadAllData();
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showLegacyLogin() {
            document.getElementById('supabaseLoginForm').style.display = 'none';
            document.getElementById('legacyLoginForm').style.display = 'block';
            document.getElementById('authError').style.display = 'none';
        }

        function showSupabaseLogin() {
            document.getElementById('legacyLoginForm').style.display = 'none';
            document.getElementById('supabaseLoginForm').style.display = 'block';
            document.getElementById('authError').style.display = 'none';
        }

        // Logout function
        async function adminLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            authToken = null;
            dataSource = 'localStorage';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
            showSupabaseLogin();
        }

        // Allow Enter key to submit
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('supabaseLoginForm').style.display !== 'none') {
                    supabaseLogin();
                } else {
                    checkPassword();
                }
            }
        });

        document.getElementById('adminEmail')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') supabaseLogin();
        });

        // ============================================
        // TAB NAVIGATION
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Show corresponding tab content
                const tabName = this.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(tabName + 'Tab').style.display = 'block';
            });
        });

        // ============================================
        // DATA LOADING
        // ============================================

        // Track data source for display
        let dataSource = 'localStorage';

        async function loadAllData() {
            // Show loading state
            document.getElementById('pendingVideosList').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('pendingMembersList').innerHTML = '<div class="loading">Loading...</div>';

            await Promise.all([
                loadPendingVideos(),
                loadPendingMemberships(),
                loadHistory(),
                loadReferralsTab()
            ]);
            await updateStats();
        }

        async function updateStats() {
            let pendingVideos = [];
            let pendingMembers = [];
            let confirmedVideos = [];
            let confirmedMembers = [];

            // Try to fetch from API if authenticated
            if (useSupabase && authToken) {
                try {
                    const videoResponse = await fetch(`${CONFIG.API_BASE_URL}/api/video-submission?admin=true`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (videoResponse.ok) {
                        const data = await videoResponse.json();
                        pendingVideos = (data.submissions || []).filter(s => s.status === 'pending_payment' || s.status === 'payment_received');
                        confirmedVideos = (data.submissions || []).filter(s => s.status === 'paid' || s.status === 'completed');
                        dataSource = 'database';
                    }
                } catch (e) {
                    console.log('API unavailable, using localStorage');
                }

                try {
                    const memberResponse = await fetch(`${CONFIG.API_BASE_URL}/api/membership?admin=true`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (memberResponse.ok) {
                        const data = await memberResponse.json();
                        pendingMembers = (data.memberships || []).filter(m => m.status === 'pending_payment' || m.status === 'payment_received');
                        confirmedMembers = (data.memberships || []).filter(m => m.status === 'active');
                    }
                } catch (e) {
                    console.log('API unavailable for memberships');
                }
            }

            // Fallback to localStorage if API didn't work
            if (dataSource === 'localStorage') {
                pendingVideos = EmailService.getPendingVideoSubmissions();
                pendingMembers = EmailService.getPendingMembershipRequests();
                confirmedVideos = JSON.parse(localStorage.getItem('pendingVideoSubmissions') || '[]').filter(s => s.paymentConfirmed);
                confirmedMembers = JSON.parse(localStorage.getItem('pendingMemberRequests') || '[]').filter(r => r.paymentConfirmed);
            }

            document.getElementById('pendingVideoCount').textContent = pendingVideos.length;
            document.getElementById('pendingMemberCount').textContent = pendingMembers.length;
            document.getElementById('totalConfirmedCount').textContent = confirmedVideos.length + confirmedMembers.length;
        }

        async function loadPendingVideos() {
            const container = document.getElementById('pendingVideosList');
            let submissions = [];

            // Try API first if authenticated
            if (useSupabase && authToken) {
                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}/api/video-submission?admin=true`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        // Filter to pending submissions
                        submissions = (data.submissions || [])
                            .filter(s => s.status === 'pending_payment' || s.status === 'payment_received')
                            .map(s => ({
                                id: s.id,
                                name: s.guest_name || 'Unknown',
                                email: s.guest_email || s.user_email || '',
                                price: `$${(s.price_cents / 100).toFixed(2)}`,
                                videoLength: s.video_length,
                                skillLevel: s.skill_level,
                                submittedAt: s.created_at,
                                phone: s.guest_phone,
                                focusAreas: s.focus_areas,
                                videoLink: s.video_url,
                                source: 'database'
                            }));
                        dataSource = 'database';
                    }
                } catch (e) {
                    console.log('API unavailable, using localStorage');
                }
            }

            // Fallback to localStorage
            if (submissions.length === 0 && dataSource === 'localStorage') {
                submissions = EmailService.getPendingVideoSubmissions();
            }

            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128249;</div>
                        <p>No pending video submissions</p>
                        <small style="color: var(--text-light);">Data source: ${dataSource}</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = submissions.map(sub => `
                <div class="order-card" data-id="${sub.id}" data-source="${sub.source || 'localStorage'}">
                    <div class="order-header">
                        <div class="order-customer">
                            <span class="customer-name">${sub.name}</span>
                            <a href="mailto:${sub.email}" class="customer-email">${sub.email}</a>
                        </div>
                        <div class="order-price">${sub.price}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-detail">
                            <span class="detail-label">Video Length</span>
                            <span class="detail-value">${sub.videoLength} minutes</span>
                        </div>
                        <div class="order-detail">
                            <span class="detail-label">Skill Level</span>
                            <span class="detail-value">${sub.skillLevel || 'Not specified'}</span>
                        </div>
                        <div class="order-detail">
                            <span class="detail-label">Submitted</span>
                            <span class="detail-value">${EmailService.formatDate(sub.submittedAt)}</span>
                        </div>
                        <div class="order-detail">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value">${sub.phone || 'Not provided'}</span>
                        </div>
                    </div>
                    ${sub.focusAreas ? `<p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px;"><strong>Focus Areas:</strong> ${sub.focusAreas}</p>` : ''}
                    <div class="order-actions">
                        <a href="${sub.videoLink}" target="_blank" class="btn-view-video">View Video</a>
                        <button class="btn-confirm" onclick="confirmVideoPayment('${sub.id}')">Confirm Payment & Send Email</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadPendingMemberships() {
            const container = document.getElementById('pendingMembersList');
            let requests = [];

            // Try API first if authenticated
            if (useSupabase && authToken) {
                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}/api/membership?admin=true`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        // Filter to pending memberships
                        requests = (data.memberships || [])
                            .filter(m => m.status === 'pending_payment' || m.status === 'payment_received')
                            .map(m => ({
                                id: m.id,
                                name: m.guest_name || 'Unknown',
                                email: m.guest_email || m.user_email || '',
                                price: m.plan === 'monthly' ? '$19.99/month' : '$199/year',
                                plan: m.plan,
                                requestedAt: m.created_at,
                                isFoundingMember: m.is_founding_member,
                                foundingNumber: m.founding_member_number,
                                source: 'database'
                            }));
                    }
                } catch (e) {
                    console.log('API unavailable for memberships');
                }
            }

            // Fallback to localStorage
            if (requests.length === 0 && dataSource === 'localStorage') {
                requests = EmailService.getPendingMembershipRequests();
            }

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128101;</div>
                        <p>No pending membership requests</p>
                        <small style="color: var(--text-light);">Data source: ${dataSource}</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="order-card" data-id="${req.id}" data-source="${req.source || 'localStorage'}">
                    <div class="order-header">
                        <div class="order-customer">
                            <span class="customer-name">${req.name}</span>
                            <a href="mailto:${req.email}" class="customer-email">${req.email}</a>
                            ${req.isFoundingMember ? `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">Founding #${req.foundingNumber || '?'}</span>` : ''}
                        </div>
                        <div class="order-price">${req.price}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-detail">
                            <span class="detail-label">Plan Type</span>
                            <span class="detail-value">${EmailService.formatPlanType(req.plan)} Membership</span>
                        </div>
                        <div class="order-detail">
                            <span class="detail-label">Requested</span>
                            <span class="detail-value">${EmailService.formatDate(req.requestedAt)}</span>
                        </div>
                    </div>
                    <div class="order-actions">
                        <button class="btn-confirm" onclick="confirmMembershipPayment('${req.id}')">Activate Membership & Send Email</button>
                    </div>
                </div>
            `).join('');
        }

        function loadHistory() {
            const videos = JSON.parse(localStorage.getItem('pendingVideoSubmissions') || '[]').filter(s => s.paymentConfirmed);
            const members = JSON.parse(localStorage.getItem('pendingMemberRequests') || '[]').filter(r => r.paymentConfirmed);

            const allConfirmed = [
                ...videos.map(v => ({ ...v, type: 'video', confirmedAt: v.confirmedAt })),
                ...members.map(m => ({ ...m, type: 'membership', confirmedAt: m.confirmedAt }))
            ].sort((a, b) => new Date(b.confirmedAt) - new Date(a.confirmedAt));

            const container = document.getElementById('historyList');

            if (allConfirmed.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128203;</div>
                        <p>No confirmation history yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allConfirmed.map(item => `
                <div class="history-item">
                    <div class="history-info">
                        <span class="history-type">${item.type === 'video' ? 'Video Analysis' : 'Membership'}</span>
                        <span class="history-name">${item.name} - ${item.price}</span>
                    </div>
                    <span class="history-date">${EmailService.formatDate(item.confirmedAt)}</span>
                </div>
            `).join('');
        }

        // ============================================
        // CONFIRMATION ACTIONS
        // ============================================
        async function confirmVideoPayment(submissionId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Sending...';

            // Get submission data
            const submissions = JSON.parse(localStorage.getItem('pendingVideoSubmissions') || '[]');
            const submission = submissions.find(s => s.id === submissionId);

            if (!submission) {
                showStatus('Submission not found', 'error');
                btn.disabled = false;
                btn.textContent = 'Confirm Payment & Send Email';
                return;
            }

            // Send payment confirmed email
            const result = await EmailService.sendVideoPaymentConfirmed({
                name: submission.name,
                email: submission.email,
                videoLength: submission.videoLength
            });

            if (result.success) {
                // Mark as confirmed
                EmailService.confirmVideoPayment(submissionId);
                showStatus(`Payment confirmed! Email sent to ${submission.email}`, 'success');
                loadAllData();
            } else {
                showStatus('Failed to send email. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Confirm Payment & Send Email';
            }
        }

        async function confirmMembershipPayment(requestId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Activating...';

            // Get request data
            const requests = JSON.parse(localStorage.getItem('pendingMemberRequests') || '[]');
            const request = requests.find(r => r.id === requestId);

            if (!request) {
                showStatus('Request not found', 'error');
                btn.disabled = false;
                btn.textContent = 'Activate Membership & Send Email';
                return;
            }

            // Send welcome email
            const result = await EmailService.sendMembershipPaymentConfirmed({
                name: request.name,
                email: request.email,
                plan: request.plan
            });

            if (result.success) {
                // Mark as confirmed and add to members
                EmailService.confirmMembershipPayment(requestId);
                showStatus(`Membership activated! Welcome email sent to ${request.email}`, 'success');
                loadAllData();
            } else {
                showStatus('Failed to send email. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Activate Membership & Send Email';
            }
        }

        // ============================================
        // STATUS MESSAGES
        // ============================================
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';

            // Scroll to status
            statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // ============================================
        // REFERRALS TAB
        // ============================================
        const REFERRAL_TIERS = [
            { level: 1, required: 1, reward: "$5 off next month", key: 'tier1Claimed' },
            { level: 2, required: 3, reward: "Free month", key: 'tier2Claimed' },
            { level: 3, required: 5, reward: "Free 30-min analysis", key: 'tier3Claimed' },
            { level: 4, required: 10, reward: "Free 60-min analysis", key: 'tier4Claimed' }
        ];

        function loadReferralsTab() {
            const members = JSON.parse(localStorage.getItem('members') || '[]');

            let totalReferrals = 0;
            let pendingCount = 0;
            let ambassadors = [];
            let unclaimedRewards = [];

            members.forEach(member => {
                // Count referrals
                if (member.referrals) {
                    if (typeof member.referrals === 'object') {
                        totalReferrals += member.referrals.total || 0;
                        pendingCount += (member.referrals.pending || []).length;
                    } else {
                        totalReferrals += member.referrals;
                    }
                }

                // Check for ambassadors
                if (member.isAmbassador) {
                    ambassadors.push(member);
                }

                // Check for unclaimed rewards
                if (member.referralRewards) {
                    const cycleCount = member.referrals?.currentCycle ||
                        (typeof member.referrals === 'number' ? member.referrals % 15 : 0);

                    REFERRAL_TIERS.forEach(tier => {
                        if (cycleCount >= tier.required && !member.referralRewards[tier.key]) {
                            unclaimedRewards.push({
                                member: member,
                                tier: tier.level,
                                reward: tier.reward,
                                claimKey: tier.key
                            });
                        }
                    });
                }
            });

            // Update stats
            document.getElementById('totalReferralsCount').textContent = totalReferrals;
            document.getElementById('pendingReferralsCount').textContent = pendingCount;
            document.getElementById('ambassadorCount').textContent = ambassadors.length;
            document.getElementById('unclaimedRewardsCount').textContent = unclaimedRewards.length;

            // Render unclaimed rewards
            renderUnclaimedRewards(unclaimedRewards);

            // Render ambassadors
            renderAmbassadors(ambassadors);

            // Render all members with referrals
            renderAllReferrals(members);
        }

        function renderUnclaimedRewards(rewards) {
            const container = document.getElementById('unclaimedRewardsList');

            if (rewards.length === 0) {
                container.innerHTML = '<p class="empty-state">No rewards waiting to be claimed</p>';
                return;
            }

            container.innerHTML = rewards.map(r => `
                <div class="reward-claim-card">
                    <div class="reward-member-info">
                        <span class="reward-member-name">${r.member.name}</span>
                        <span class="reward-member-email">${r.member.email}</span>
                    </div>
                    <div class="reward-info">
                        <span class="reward-tier-badge">Tier ${r.tier}</span>
                        <span class="reward-name">${r.reward}</span>
                    </div>
                    <button class="btn-claim" onclick="markRewardClaimed('${r.member.email}', '${r.claimKey}', '${r.reward}')">
                        Mark as Claimed
                    </button>
                </div>
            `).join('');
        }

        function renderAmbassadors(ambassadors) {
            const container = document.getElementById('ambassadorsList');

            if (ambassadors.length === 0) {
                container.innerHTML = '<p class="empty-state">No ambassadors yet</p>';
                return;
            }

            container.innerHTML = ambassadors.map(a => {
                const totalRefs = a.referrals?.total || (typeof a.referrals === 'number' ? a.referrals : 0);
                const since = a.ambassadorSince ? new Date(a.ambassadorSince).toLocaleDateString() : 'N/A';
                return `
                    <div class="ambassador-card">
                        <div class="ambassador-info">
                            <span class="ambassador-name">${a.name}<span class="ambassador-badge-small">AMBASSADOR</span></span>
                            <span class="ambassador-email">${a.email}</span>
                        </div>
                        <div class="ambassador-stats">
                            <div>Total Referrals: ${totalRefs}</div>
                            <div>Since: ${since}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAllReferrals(members) {
            const container = document.getElementById('allReferralsList');

            // Get members with referrals and sort by count
            const withReferrals = members
                .filter(m => {
                    const count = m.referrals?.total || (typeof m.referrals === 'number' ? m.referrals : 0);
                    return count > 0;
                })
                .sort((a, b) => {
                    const aCount = a.referrals?.total || (typeof a.referrals === 'number' ? a.referrals : 0);
                    const bCount = b.referrals?.total || (typeof b.referrals === 'number' ? b.referrals : 0);
                    return bCount - aCount;
                });

            if (withReferrals.length === 0) {
                container.innerHTML = '<p class="empty-state">No referrals yet</p>';
                return;
            }

            container.innerHTML = withReferrals.map(m => {
                const total = m.referrals?.total || (typeof m.referrals === 'number' ? m.referrals : 0);
                const pending = m.referrals?.pending?.length || 0;
                const badge = m.isAmbassador ? '<span class="ambassador-badge-small">‚≠ê</span>' : '';
                return `
                    <div class="referral-row">
                        <span class="referrer-name">${m.name} ${badge}</span>
                        <span class="referral-count">${total} confirmed${pending > 0 ? `, ${pending} pending` : ''}</span>
                    </div>
                `;
            }).join('');
        }

        function markRewardClaimed(email, claimKey, rewardName) {
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const memberIndex = members.findIndex(m => m.email.toLowerCase() === email.toLowerCase());

            if (memberIndex === -1) {
                showStatus('Member not found', 'error');
                return;
            }

            const member = members[memberIndex];

            // Initialize if needed
            if (!member.referralRewards) {
                member.referralRewards = {};
            }

            // Mark as claimed
            member.referralRewards[claimKey] = true;
            member.referralRewards.claimHistory = member.referralRewards.claimHistory || [];
            member.referralRewards.claimHistory.push({
                tier: parseInt(claimKey.replace('tier', '').replace('Claimed', '')),
                reward: rewardName,
                claimedAt: new Date().toISOString(),
                claimedByAdmin: true
            });

            // Save
            members[memberIndex] = member;
            localStorage.setItem('members', JSON.stringify(members));

            // Send notification email if available
            if (typeof EmailService !== 'undefined' && EmailService.sendRewardClaimed) {
                EmailService.sendRewardClaimed({
                    name: member.name,
                    email: member.email,
                    reward: rewardName
                });
            }

            showStatus(`"${rewardName}" marked as claimed for ${member.name}`, 'success');
            loadReferralsTab();
        }

        // ============================================
        // INSTRUCTORS TAB
        // ============================================
        function loadInstructorsTab() {
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');

            // Calculate stats
            const total = instructors.length;
            const active = instructors.filter(i => i.status === 'active').length;
            const paused = instructors.filter(i => i.status === 'paused').length;

            // Check grace periods
            const now = new Date();
            let inGrace = 0;
            let needingAttention = [];

            instructors.forEach(i => {
                if (i.gracePeriodEnds) {
                    const graceEnd = new Date(i.gracePeriodEnds);
                    const daysLeft = Math.ceil((graceEnd - now) / (1000 * 60 * 60 * 24));

                    if (daysLeft > 0) {
                        inGrace++;
                        // Within 14 days of ending
                        if (daysLeft <= 14 && i.status === 'active') {
                            needingAttention.push({ ...i, daysLeft });
                        }
                    }
                }
            });

            // Update stats
            document.getElementById('totalInstructorsCount').textContent = total;
            document.getElementById('activeInstructorsCount').textContent = active;
            document.getElementById('graceInstructorsCount').textContent = inGrace;
            document.getElementById('pausedInstructorsCount').textContent = paused;

            // Render needs attention
            renderInstructorsNeedingAttention(needingAttention);

            // Render all instructors
            renderAllInstructors(instructors);
        }

        function renderInstructorsNeedingAttention(instructors) {
            const container = document.getElementById('instructorsNeedingAttention');

            if (instructors.length === 0) {
                container.innerHTML = '<p class="empty-state">No instructors need attention right now</p>';
                return;
            }

            container.innerHTML = instructors.map(i => {
                const monthRefs = i.referrals?.currentMonth || 0;
                return `
                    <div class="instructor-admin-card grace-ending">
                        <div class="instructor-admin-info">
                            <span class="instructor-admin-name">${i.name}</span>
                            <span class="instructor-admin-email">${i.email}</span>
                            <span class="instructor-admin-location">üìç ${i.city}, ${i.state}</span>
                        </div>
                        <div class="instructor-admin-stats">
                            <div class="inst-stat">
                                <span class="inst-stat-value">${monthRefs}/2</span>
                                <span class="inst-stat-label">This Month</span>
                            </div>
                            <div class="inst-stat">
                                <span class="inst-stat-value">${i.referrals?.total || 0}</span>
                                <span class="inst-stat-label">Total Refs</span>
                            </div>
                        </div>
                        <div class="instructor-admin-status">
                            <span class="status-badge grace">Grace Period</span>
                            <span class="grace-countdown">‚è∞ ${i.daysLeft} days left</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAllInstructors(instructors) {
            const container = document.getElementById('allInstructorsList');

            if (instructors.length === 0) {
                container.innerHTML = '<p class="empty-state">No instructors registered yet</p>';
                return;
            }

            // Sort: active first, then by join date
            const sorted = [...instructors].sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                return new Date(b.joinedAt) - new Date(a.joinedAt);
            });

            container.innerHTML = sorted.map(i => {
                const now = new Date();
                const graceEnd = i.gracePeriodEnds ? new Date(i.gracePeriodEnds) : null;
                const daysLeft = graceEnd ? Math.max(0, Math.ceil((graceEnd - now) / (1000 * 60 * 60 * 24))) : 0;
                const inGrace = daysLeft > 0;
                const monthRefs = i.referrals?.currentMonth || 0;

                let statusBadge = '';
                if (i.status === 'active') {
                    statusBadge = inGrace
                        ? `<span class="status-badge grace">Grace (${daysLeft}d)</span>`
                        : `<span class="status-badge active">Active</span>`;
                } else {
                    statusBadge = `<span class="status-badge paused">Paused</span>`;
                }

                const cardClass = i.status === 'paused' ? 'instructor-admin-card paused' : 'instructor-admin-card';

                return `
                    <div class="${cardClass}">
                        <div class="instructor-admin-info">
                            <span class="instructor-admin-name">${i.name}</span>
                            <span class="instructor-admin-email">${i.email}</span>
                            <span class="instructor-admin-location">üìç ${i.city}, ${i.state}</span>
                        </div>
                        <div class="instructor-admin-stats">
                            <div class="inst-stat">
                                <span class="inst-stat-value">${monthRefs}/2</span>
                                <span class="inst-stat-label">This Month</span>
                            </div>
                            <div class="inst-stat">
                                <span class="inst-stat-value">${i.referrals?.total || 0}</span>
                                <span class="inst-stat-label">Total</span>
                            </div>
                            <div class="inst-stat">
                                <span class="inst-stat-value" style="color: #10b981;">${(i.referralsFromRay || []).length}</span>
                                <span class="inst-stat-label">From Ray</span>
                            </div>
                        </div>
                        <div class="instructor-admin-status">
                            ${statusBadge}
                            <div class="instructor-admin-actions">
                                ${i.status === 'paused'
                                    ? `<button class="btn-small activate" onclick="activateInstructor('${i.email}')">Activate</button>`
                                    : `<button class="btn-small pause" onclick="pauseInstructor('${i.email}')">Pause</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function activateInstructor(email) {
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const index = instructors.findIndex(i => i.email.toLowerCase() === email.toLowerCase());

            if (index !== -1) {
                instructors[index].status = 'active';
                localStorage.setItem('instructors', JSON.stringify(instructors));
                showStatus(`${instructors[index].name} has been activated`, 'success');
                loadInstructorsTab();
            }
        }

        function pauseInstructor(email) {
            if (!confirm('Are you sure you want to pause this instructor? Their profile will be hidden.')) {
                return;
            }

            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const index = instructors.findIndex(i => i.email.toLowerCase() === email.toLowerCase());

            if (index !== -1) {
                instructors[index].status = 'paused';
                localStorage.setItem('instructors', JSON.stringify(instructors));
                showStatus(`${instructors[index].name} has been paused`, 'success');
                loadInstructorsTab();
            }
        }

        // Update loadAllData to include instructors and evaluations
        const originalLoadAllData = loadAllData;
        loadAllData = function() {
            originalLoadAllData();
            loadInstructorsTab();
            populateInstructorDropdown();
            loadEvaluationsTab();
        };

        // ============================================
        // EVALUATIONS TAB
        // ============================================
        let currentEvalId = null;

        function loadEvaluationsTab() {
            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');

            // Categorize evaluations
            const pending = evaluations.filter(e => e.status === 'pending' && e.paymentStatus === 'paid');
            const awaitingPayment = evaluations.filter(e => e.paymentStatus === 'pending');
            const completed = evaluations.filter(e => e.status === 'completed');

            // Update stats
            document.getElementById('pendingEvalsCount').textContent = pending.length;
            document.getElementById('awaitingPaymentCount').textContent = awaitingPayment.length;
            document.getElementById('completedEvalsCount').textContent = completed.length;

            // Render lists
            renderPendingEvals(pending);
            renderAwaitingPayment(awaitingPayment);
            renderCompletedEvals(completed);
        }

        function renderPendingEvals(evals) {
            const container = document.getElementById('pendingEvalsList');

            if (evals.length === 0) {
                container.innerHTML = '<p class="empty-state">No evaluations ready to complete</p>';
                return;
            }

            container.innerHTML = evals.map(e => `
                <div class="eval-card">
                    <div class="eval-header">
                        <div class="eval-customer-info">
                            <span class="eval-customer-name">${e.customerName}</span>
                            <a href="mailto:${e.customerEmail}" class="eval-customer-email">${e.customerEmail}</a>
                        </div>
                        <div class="eval-price">$${e.amount}</div>
                    </div>
                    <div class="eval-details">
                        <div class="eval-detail-item">
                            <span class="eval-detail-label">Self-Assessed Level</span>
                            <span class="eval-detail-value">${e.selfAssessedLevel || 'Not specified'}</span>
                        </div>
                        <div class="eval-detail-item">
                            <span class="eval-detail-label">Submitted</span>
                            <span class="eval-detail-value">${new Date(e.submittedAt).toLocaleDateString()}</span>
                        </div>
                        <div class="eval-detail-item">
                            <span class="eval-detail-label">Payment</span>
                            <span class="eval-detail-value" style="color: #059669;">‚úì Paid via ${e.paymentMethod}</span>
                        </div>
                    </div>
                    <div class="eval-actions">
                        <a href="${e.videoUrl}" target="_blank" class="btn-view-video">Watch Video</a>
                        <button class="btn-confirm" onclick="openEvalModal('${e.id}')">Complete Evaluation</button>
                    </div>
                </div>
            `).join('');
        }

        function renderAwaitingPayment(evals) {
            const container = document.getElementById('awaitingPaymentList');

            if (evals.length === 0) {
                container.innerHTML = '<p class="empty-state">No evaluations awaiting payment</p>';
                return;
            }

            container.innerHTML = evals.map(e => `
                <div class="eval-card awaiting-payment">
                    <div class="eval-header">
                        <div class="eval-customer-info">
                            <span class="eval-customer-name">${e.customerName}</span>
                            <a href="mailto:${e.customerEmail}" class="eval-customer-email">${e.customerEmail}</a>
                        </div>
                        <div class="eval-price">$${e.amount}</div>
                    </div>
                    <div class="eval-details">
                        <div class="eval-detail-item">
                            <span class="eval-detail-label">Payment Method</span>
                            <span class="eval-detail-value">${e.paymentMethod === 'venmo' ? 'Venmo (awaiting)' : 'Credit Card'}</span>
                        </div>
                        <div class="eval-detail-item">
                            <span class="eval-detail-label">Submitted</span>
                            <span class="eval-detail-value">${new Date(e.submittedAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="eval-actions">
                        <a href="${e.videoUrl}" target="_blank" class="btn-view-video">View Video</a>
                        <button class="btn-confirm" onclick="confirmEvalPayment('${e.id}')">Confirm Venmo Payment</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCompletedEvals(evals) {
            const container = document.getElementById('completedEvalsList');

            // Sort by completion date, most recent first
            const sorted = [...evals].sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)).slice(0, 10);

            if (sorted.length === 0) {
                container.innerHTML = '<p class="empty-state">No completed evaluations yet</p>';
                return;
            }

            container.innerHTML = sorted.map(e => `
                <div class="eval-card completed">
                    <div class="eval-header">
                        <div class="eval-customer-info">
                            <span class="eval-customer-name">${e.customerName}</span>
                            <span class="eval-customer-email">${e.customerEmail}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-light);">Completed</div>
                            <div style="font-weight: 500;">${new Date(e.completedAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="eval-result-box">
                        <div class="eval-result-level">Level: ${e.results?.overallLevel || 'N/A'}</div>
                        <div class="eval-result-summary">${e.results?.summary || 'No summary provided'}</div>
                    </div>
                </div>
            `).join('');
        }

        function confirmEvalPayment(evalId) {
            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const index = evaluations.findIndex(e => e.id === evalId);

            if (index === -1) {
                showStatus('Evaluation not found', 'error');
                return;
            }

            evaluations[index].paymentStatus = 'paid';
            localStorage.setItem('evaluations', JSON.stringify(evaluations));

            showStatus(`Payment confirmed for ${evaluations[index].customerName}`, 'success');
            loadEvaluationsTab();
        }

        function openEvalModal(evalId) {
            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const eval_ = evaluations.find(e => e.id === evalId);

            if (!eval_) return;

            currentEvalId = evalId;
            document.getElementById('evalModalCustomer').textContent = `Evaluating: ${eval_.customerName} (${eval_.customerEmail})`;
            document.getElementById('evalLevel').value = '';
            document.getElementById('evalSummary').value = '';

            document.getElementById('evalModal').style.display = 'flex';
        }

        function closeEvalModal() {
            document.getElementById('evalModal').style.display = 'none';
            currentEvalId = null;
        }

        async function submitEvaluation() {
            const level = document.getElementById('evalLevel').value;
            const summary = document.getElementById('evalSummary').value.trim();

            if (!level) {
                alert('Please select a skill level');
                return;
            }

            if (!summary) {
                alert('Please write an evaluation summary');
                return;
            }

            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const index = evaluations.findIndex(e => e.id === currentEvalId);

            if (index === -1) {
                showStatus('Evaluation not found', 'error');
                return;
            }

            // Update evaluation
            evaluations[index].status = 'completed';
            evaluations[index].completedAt = new Date().toISOString();
            evaluations[index].results = {
                overallLevel: level,
                summary: summary
            };

            localStorage.setItem('evaluations', JSON.stringify(evaluations));

            // TODO: Send email with results
            // await EmailService.sendEvaluationComplete(...)

            closeEvalModal();
            showStatus(`Evaluation sent to ${evaluations[index].customerEmail}!`, 'success');
            loadEvaluationsTab();
        }

        // Populate instructor dropdown for Ray's referrals
        function populateInstructorDropdown() {
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const select = document.getElementById('referToInstructor');

            select.innerHTML = '<option value="">Select instructor...</option>';
            instructors.filter(i => i.status === 'active').forEach(i => {
                select.innerHTML += `<option value="${i.email}">${i.name} - ${i.city}, ${i.state}</option>`;
            });
        }

        // ============================================
        // BADGE MANAGEMENT
        // ============================================
        let allBadges = [];
        let editingBadgeId = null;

        async function loadBadgesTab() {
            const grid = document.getElementById('adminBadgesGrid');
            grid.innerHTML = '<div class="loading">Loading badges...</div>';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api-gamification/badges?admin=true`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                if (!response.ok) throw new Error('Failed to fetch badges');
                const data = await response.json();

                // Flatten grouped badges into array
                allBadges = [];
                for (const [category, badges] of Object.entries(data.badges || {})) {
                    for (const badge of badges) {
                        allBadges.push(badge);
                    }
                }

                // Populate category filter dropdown
                const categories = [...new Set(allBadges.map(b => b.category))].sort();
                const catFilter = document.getElementById('badgeCategoryFilter');
                catFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(c => {
                    catFilter.innerHTML += `<option value="${c}">${c} (${allBadges.filter(b => b.category === c).length})</option>`;
                });

                updateBadgeStats();
                renderBadgesAdmin(allBadges);
            } catch (err) {
                console.error('Load badges error:', err);
                grid.innerHTML = '<p style="color: #dc2626;">Failed to load badges. Make sure the database has been seeded.</p>';
            }
        }

        function updateBadgeStats() {
            document.getElementById('badgeTotalCount').textContent = allBadges.length;
            document.getElementById('badgeCategoryCount').textContent = new Set(allBadges.map(b => b.category)).size;
            document.getElementById('badgeRareCount').textContent = allBadges.filter(b => ['rare', 'epic', 'legendary'].includes(b.rarity)).length;
            document.getElementById('badgeHiddenCount').textContent = allBadges.filter(b => b.is_hidden).length;
        }

        function filterBadgesAdmin() {
            const search = document.getElementById('badgeSearchInput').value.toLowerCase();
            const category = document.getElementById('badgeCategoryFilter').value;
            const rarity = document.getElementById('badgeRarityFilter').value;

            const filtered = allBadges.filter(b => {
                if (search && !b.name.toLowerCase().includes(search) && !b.description.toLowerCase().includes(search) && !b.id.toLowerCase().includes(search)) return false;
                if (category && b.category !== category) return false;
                if (rarity && b.rarity !== rarity) return false;
                return true;
            });

            renderBadgesAdmin(filtered);
        }

        function renderBadgesAdmin(badges) {
            const grid = document.getElementById('adminBadgesGrid');

            if (badges.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-light); padding: 20px; text-align: center;">No badges match your filters.</p>';
                return;
            }

            grid.innerHTML = badges.map(b => `
                <div class="admin-badge-card rarity-${b.rarity || 'common'} ${b.is_hidden ? 'is-hidden' : ''}" data-badge-id="${b.id}">
                    <div class="admin-badge-icon">${b.icon}</div>
                    <div class="admin-badge-info">
                        <span class="admin-badge-name">${b.name}</span>
                        <span class="admin-badge-desc">${b.description}</span>
                        <div class="admin-badge-meta">
                            <span class="badge-tag cat-tag">${b.category}</span>
                            <span class="badge-tag type-tag">${b.requirement_action || b.requirement_type}</span>
                            <span class="badge-tag rarity-${b.rarity || 'common'}">${b.rarity || 'common'}</span>
                            <span class="badge-tag cat-tag">req: ${b.requirement_value}</span>
                            ${b.xp_reward ? `<span class="badge-tag cat-tag">${b.xp_reward} XP</span>` : ''}
                            ${b.is_hidden ? '<span class="badge-tag hidden-tag">hidden</span>' : ''}
                        </div>
                    </div>
                    <div class="admin-badge-actions">
                        <button onclick="openBadgeModal('${b.id}')" class="btn-icon" title="Edit">&#9998;</button>
                        <button onclick="deleteBadge('${b.id}')" class="btn-icon btn-danger" title="Delete">&#128465;</button>
                    </div>
                </div>
            `).join('');

            // Update count label
            const existing = document.getElementById('badgeCountLabel');
            if (existing) existing.remove();
            const label = document.createElement('p');
            label.id = 'badgeCountLabel';
            label.className = 'badge-count-label';
            label.textContent = `Showing ${badges.length} of ${allBadges.length} badges`;
            grid.parentNode.insertBefore(label, grid);
        }

        function openBadgeModal(badgeId) {
            editingBadgeId = badgeId || null;
            document.getElementById('badgeModalTitle').textContent = badgeId ? 'Edit Badge' : 'Add Badge';

            if (badgeId) {
                const badge = allBadges.find(b => b.id === badgeId);
                if (!badge) return;
                document.getElementById('badgeFormId').value = badge.id;
                document.getElementById('badgeFormId').disabled = true;
                document.getElementById('badgeFormIcon').value = badge.icon;
                document.getElementById('badgeFormName').value = badge.name;
                document.getElementById('badgeFormDesc').value = badge.description;
                document.getElementById('badgeFormCategory').value = badge.category;
                document.getElementById('badgeFormReqType').value = badge.requirement_type;
                document.getElementById('badgeFormReqValue').value = badge.requirement_value;
                document.getElementById('badgeFormReqAction').value = badge.requirement_action || '';
                document.getElementById('badgeFormRarity').value = badge.rarity || 'common';
                document.getElementById('badgeFormXP').value = badge.xp_reward || 0;
                document.getElementById('badgeFormHidden').checked = badge.is_hidden || false;
            } else {
                document.getElementById('badgeFormId').value = '';
                document.getElementById('badgeFormId').disabled = false;
                document.getElementById('badgeFormIcon').value = '';
                document.getElementById('badgeFormName').value = '';
                document.getElementById('badgeFormDesc').value = '';
                document.getElementById('badgeFormCategory').value = 'streak';
                document.getElementById('badgeFormReqType').value = '';
                document.getElementById('badgeFormReqValue').value = '1';
                document.getElementById('badgeFormReqAction').value = '';
                document.getElementById('badgeFormRarity').value = 'common';
                document.getElementById('badgeFormXP').value = '0';
                document.getElementById('badgeFormHidden').checked = false;
            }

            document.getElementById('badgeModal').style.display = 'flex';
        }

        function closeBadgeModal() {
            document.getElementById('badgeModal').style.display = 'none';
            editingBadgeId = null;
        }

        async function saveBadge() {
            const badgeData = {
                id: document.getElementById('badgeFormId').value.trim(),
                icon: document.getElementById('badgeFormIcon').value.trim(),
                name: document.getElementById('badgeFormName').value.trim(),
                description: document.getElementById('badgeFormDesc').value.trim(),
                category: document.getElementById('badgeFormCategory').value,
                requirement_type: document.getElementById('badgeFormReqType').value.trim() || 'count',
                requirement_value: parseFloat(document.getElementById('badgeFormReqValue').value) || 1,
                requirement_action: document.getElementById('badgeFormReqAction').value.trim(),
                rarity: document.getElementById('badgeFormRarity').value,
                xp_reward: parseInt(document.getElementById('badgeFormXP').value) || 0,
                is_hidden: document.getElementById('badgeFormHidden').checked
            };

            if (!badgeData.id || !badgeData.name || !badgeData.icon) {
                showStatus('Badge ID, Name, and Icon are required', 'error');
                return;
            }

            try {
                const isEdit = !!editingBadgeId;
                const url = isEdit
                    ? `${CONFIG.API_BASE_URL}/api-gamification/badges/${encodeURIComponent(editingBadgeId)}`
                    : `${CONFIG.API_BASE_URL}/api-gamification/badges`;

                const response = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(badgeData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Save failed');
                }

                showStatus(`Badge "${badgeData.name}" ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
                closeBadgeModal();
                await loadBadgesTab();
            } catch (err) {
                showStatus(`Error: ${err.message}`, 'error');
            }
        }

        async function deleteBadge(badgeId) {
            const badge = allBadges.find(b => b.id === badgeId);
            if (!confirm(`Delete badge "${badge?.name || badgeId}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api-gamification/badges/${encodeURIComponent(badgeId)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Delete failed');
                }

                showStatus(`Badge deleted. ${result.usersAffected > 0 ? `(${result.usersAffected} users had this badge)` : ''}`, 'success');
                await loadBadgesTab();
            } catch (err) {
                showStatus(`Error: ${err.message}`, 'error');
            }
        }

        // Load badges tab when it becomes active
        const originalTabHandler = document.querySelectorAll('.tab-btn');
        originalTabHandler.forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.dataset.tab === 'badges' && allBadges.length === 0) {
                    loadBadgesTab();
                }
            });
        });

        // Log when Ray refers a student to an instructor
        function logRayReferral() {
            const studentName = document.getElementById('referStudentName').value.trim();
            const instructorEmail = document.getElementById('referToInstructor').value;

            if (!studentName || !instructorEmail) {
                showStatus('Please enter student name and select an instructor', 'error');
                return;
            }

            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const index = instructors.findIndex(i => i.email === instructorEmail);

            if (index === -1) {
                showStatus('Instructor not found', 'error');
                return;
            }

            // Initialize referrals received from Ray
            if (!instructors[index].referralsFromRay) {
                instructors[index].referralsFromRay = [];
            }

            // Add the referral
            instructors[index].referralsFromRay.push({
                studentName,
                referredAt: new Date().toISOString()
            });

            localStorage.setItem('instructors', JSON.stringify(instructors));

            // Clear form
            document.getElementById('referStudentName').value = '';
            document.getElementById('referToInstructor').value = '';

            showStatus(`Logged referral: ${studentName} ‚Üí ${instructors[index].name}`, 'success');
            loadInstructorsTab();
        }
    </script>
</body>
</html>
