<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Drill Video - AI Drill Coach | Ray Paull Pickleball</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="../index.html">Ray's Pickleball</a>
            </div>
            <ul class="nav-links">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../about.html">About</a></li>
                <li><a href="../services.html">Services</a></li>
                <li><a href="../pricing.html">Pricing</a></li>
                <li><a href="../community.html">Community</a></li>
                <li><a href="../membership.html">Membership</a></li>
                <li><a href="../coach-analysis/video-analysis.html">Submit Video</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="page-header">
            <h1>Upload Your Drill Video</h1>
            <p>Get instant AI-powered feedback on your technique</p>
        </section>

        <section class="upload-content">
            <div class="container">
                <div class="upload-grid">

                    <!-- UPLOAD FORM -->
                    <div class="upload-form-container">
                        <div class="usage-meter" id="usageMeter">
                            <!-- Credit users see: "X / 30 credits remaining" -->
                            <!-- Subscribers see: "Unlimited" badge -->
                            <span class="usage-label" id="usageLabel">Credits remaining:</span>
                            <span class="usage-count" id="usageDisplay"><span id="usageCount">30</span> / 30</span>
                            <div class="usage-bar" id="usageBar">
                                <div class="usage-fill" id="usageFill" style="width: 100%"></div>
                            </div>
                        </div>

                        <form id="uploadForm" class="contact-form">
                            <!-- Video Upload Area -->
                            <div class="form-group">
                                <label>Upload Video *</label>
                                <div class="upload-dropzone" id="dropzone">
                                    <div class="dropzone-content" id="dropzoneContent">
                                        <span class="dropzone-icon">üìπ</span>
                                        <p class="dropzone-text">Drag & drop your video here</p>
                                        <p class="dropzone-subtext">or click to browse</p>
                                        <p class="dropzone-requirements">MP4, MOV, or WebM ‚Ä¢ 30-60 seconds ‚Ä¢ Max 100MB</p>
                                    </div>
                                    <div class="dropzone-preview" id="dropzonePreview" style="display: none;">
                                        <video id="videoPreview" controls></video>
                                        <button type="button" class="remove-video-btn" id="removeVideo">Remove</button>
                                    </div>
                                    <input type="file" id="videoInput" accept="video/mp4,video/quicktime,video/webm" hidden>
                                </div>
                                <div class="upload-progress" id="uploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                    <span class="progress-text" id="progressText">Uploading... 0%</span>
                                </div>
                            </div>

                            <!-- Drill Type -->
                            <div class="form-group">
                                <label for="drillType">Drill Type *</label>
                                <select id="drillType" required>
                                    <option value="">Select the type of drill...</option>
                                    <option value="dinking">Dinking Drills</option>
                                    <option value="third-shot-drop">Third Shot Drops</option>
                                    <option value="speed-up">Speed-ups & Counters</option>
                                    <option value="reset">Reset Drills</option>
                                    <option value="volley">Volley Practice</option>
                                    <option value="serve">Serve Practice</option>
                                    <option value="return">Return Practice</option>
                                    <option value="transition">Transition Zone Work</option>
                                    <option value="other">Other</option>
                                </select>
                                <p class="drill-duration-note">Ideal video: 20-60 seconds of a single drill</p>
                            </div>

                            <!-- Focus Area (Optional) -->
                            <div class="form-group">
                                <label for="focusArea">Focus Area (optional)</label>
                                <textarea id="focusArea" rows="2" placeholder="Any specific aspect you want feedback on? e.g., 'My backhand dinks keep popping up'"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary btn-full btn-large" id="analyzeBtn" disabled>
                                <span class="btn-text">Analyze My Video</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="spinner"></span> Analyzing...
                                </span>
                            </button>
                        </form>

                        <!-- Error Message -->
                        <div class="error-message" id="errorMessage" style="display: none;"></div>
                    </div>

                    <!-- TIPS SIDEBAR -->
                    <div class="upload-tips">
                        <h3>Tips for Best Results</h3>

                        <div class="tip-card">
                            <span class="tip-icon">üìè</span>
                            <div class="tip-content">
                                <h4>Video Length</h4>
                                <p>30-60 seconds is ideal. Include multiple repetitions of the same drill.</p>
                            </div>
                        </div>

                        <div class="tip-card">
                            <span class="tip-icon">üìê</span>
                            <div class="tip-content">
                                <h4>Camera Angle</h4>
                                <p>Side view or behind view works best. Make sure your full body is visible.</p>
                            </div>
                        </div>

                        <div class="tip-card">
                            <span class="tip-icon">üí°</span>
                            <div class="tip-content">
                                <h4>Good Lighting</h4>
                                <p>Natural light or well-lit indoor courts. Avoid backlighting.</p>
                            </div>
                        </div>

                        <div class="tip-card">
                            <span class="tip-icon">üéØ</span>
                            <div class="tip-content">
                                <h4>One Drill Per Video</h4>
                                <p>Focus on a single drill type for more specific feedback.</p>
                            </div>
                        </div>

                        <div class="recent-analyses">
                            <h4>Recent Analyses</h4>
                            <ul id="recentAnalyses">
                                <li class="no-analyses">No analyses yet. Upload your first video!</li>
                            </ul>
                            <a href="account.html" class="view-all-link">View All History</a>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Ray Paull Pickleball Analysis. All rights reserved.</p>
        </div>
    </footer>

    <style>
        /* Upload Page Styles */
        .upload-content {
            padding: var(--section-padding) 20px;
            background: var(--background-alt);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }

        .upload-form-container {
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Usage Meter */
        .usage-meter {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .usage-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .usage-count {
            font-weight: 600;
            color: var(--text-color);
        }

        .usage-bar {
            flex: 1;
            min-width: 100px;
            height: 8px;
            background: var(--background-alt);
            border-radius: 4px;
            overflow: hidden;
        }

        .usage-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .unlimited-badge {
            background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Dropzone */
        .upload-dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--background-alt);
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .dropzone-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
        }

        .dropzone-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .dropzone-subtext {
            color: var(--primary-color);
            font-size: 0.95rem;
        }

        .dropzone-requirements {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-top: 15px;
        }

        .drill-duration-note {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Video Preview */
        .dropzone-preview {
            position: relative;
        }

        .dropzone-preview video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            background: black;
        }

        .remove-video-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .remove-video-btn:hover {
            background: #dc2626;
        }

        /* Progress Bar */
        .upload-progress {
            margin-top: 15px;
        }

        .progress-bar {
            height: 8px;
            background: var(--background-alt);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Button States */
        .btn-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Error Message */
        .error-message {
            margin-top: 20px;
            padding: 15px;
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 8px;
            color: #991b1b;
        }

        /* Tips Sidebar */
        .upload-tips {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }

        .upload-tips h3 {
            margin-bottom: 25px;
            font-size: 1.2rem;
        }

        .tip-card {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tip-card:last-of-type {
            border-bottom: none;
            margin-bottom: 30px;
        }

        .tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .tip-content h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .tip-content p {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Recent Analyses */
        .recent-analyses {
            background: var(--background-alt);
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
        }

        .recent-analyses h4 {
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .recent-analyses ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .recent-analyses li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .recent-analyses li:last-child {
            border-bottom: none;
        }

        .recent-analyses .no-analyses {
            color: var(--text-light);
            font-style: italic;
        }

        .view-all-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--primary-color);
        }
    </style>

    <script>
        // ============================================
        // VIDEO UPLOAD HANDLING
        // ============================================

        const dropzone = document.getElementById('dropzone');
        const dropzoneContent = document.getElementById('dropzoneContent');
        const dropzonePreview = document.getElementById('dropzonePreview');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const removeVideoBtn = document.getElementById('removeVideo');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const uploadForm = document.getElementById('uploadForm');
        const errorMessage = document.getElementById('errorMessage');

        let selectedFile = null;
        let uploadedVideoUrl = null;

        // Click to upload
        dropzone.addEventListener('click', () => {
            if (!selectedFile) {
                videoInput.click();
            }
        });

        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // File input change
        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Handle file selection
        function handleFileSelect(file) {
            // Validate file type
            const validTypes = ['video/mp4', 'video/quicktime', 'video/webm'];
            if (!validTypes.includes(file.type)) {
                showError('Please upload an MP4, MOV, or WebM video file.');
                return;
            }

            // Validate file size (100MB max)
            if (file.size > 100 * 1024 * 1024) {
                showError('Video file must be under 100MB.');
                return;
            }

            selectedFile = file;
            hideError();

            // Show preview
            const videoUrl = URL.createObjectURL(file);
            videoPreview.src = videoUrl;
            dropzoneContent.style.display = 'none';
            dropzonePreview.style.display = 'block';

            // Validate duration when metadata loads
            videoPreview.addEventListener('loadedmetadata', () => {
                const duration = videoPreview.duration;
                if (duration < 10) {
                    showError('Video is too short. Please upload at least 10 seconds of footage.');
                    removeVideo();
                    return;
                }
                if (duration > 120) {
                    showError('Video is too long. Please upload 30-60 seconds of footage (max 2 minutes).');
                    removeVideo();
                    return;
                }
                // Enable analyze button
                analyzeBtn.disabled = false;
            });
        }

        // Remove video
        removeVideoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeVideo();
        });

        function removeVideo() {
            selectedFile = null;
            uploadedVideoUrl = null;
            videoInput.value = '';
            videoPreview.src = '';
            dropzoneContent.style.display = 'block';
            dropzonePreview.style.display = 'none';
            analyzeBtn.disabled = true;
        }

        // Show/hide errors
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // ============================================
        // FORM SUBMISSION
        // ============================================

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                showError('Please select a video to upload.');
                return;
            }

            const drillType = document.getElementById('drillType').value;
            if (!drillType) {
                showError('Please select a drill type.');
                return;
            }

            const focusArea = document.getElementById('focusArea').value;

            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.querySelector('.btn-text').style.display = 'none';
            analyzeBtn.querySelector('.btn-loading').style.display = 'flex';
            uploadProgress.style.display = 'block';
            hideError();

            try {
                // Step 1: Upload video (simulated for now - will use Cloudinary)
                await simulateUpload();

                // Step 2: Send to analysis API
                progressText.textContent = 'Analyzing your technique...';
                progressFill.style.width = '100%';

                // For MVP: Call the serverless function
                // const response = await fetch('/.netlify/functions/analyze-video', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({
                //         videoUrl: uploadedVideoUrl,
                //         drillType: drillType,
                //         focusArea: focusArea
                //     })
                // });

                // Simulate API response for demo
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Store in localStorage and redirect to results
                const analysisResult = {
                    id: Date.now(),
                    drillType: drillType,
                    focusArea: focusArea,
                    timestamp: new Date().toISOString(),
                    // This would come from the API
                    grade: 'B+',
                    strengths: [
                        'Consistent paddle face angle on forehand',
                        'Good knee bend maintaining athletic stance',
                        'Smooth weight transfer on most shots'
                    ],
                    primaryIssue: 'Contact point is slightly behind your body on backhand shots, causing the ball to pop up higher than intended.',
                    howToFix: 'Focus on getting your paddle out in front earlier. Place a cone 6 inches in front of your lead foot and practice making contact before the ball reaches the cone line. This forces earlier preparation.',
                    drillRecommendation: '"Shadow Dink with Contact Marker" ‚Äî 3 sets of 20 reps on backhand side, focusing on early contact point. Film again after 1 week.'
                };

                localStorage.setItem('lastAnalysis', JSON.stringify(analysisResult));

                // Update usage count
                let usage = parseInt(localStorage.getItem('analysisUsage') || '0');
                localStorage.setItem('analysisUsage', usage + 1);

                // Save to history
                let history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                history.unshift(analysisResult);
                if (history.length > 20) history.pop();
                localStorage.setItem('analysisHistory', JSON.stringify(history));

                // Redirect to results
                window.location.href = 'drill-results.html';

            } catch (error) {
                console.error('Analysis failed:', error);
                showError('Something went wrong. Please try again.');
                resetForm();
            }
        });

        // Simulate upload progress
        function simulateUpload() {
            return new Promise((resolve) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 90) {
                        progress = 90;
                        clearInterval(interval);
                        progressFill.style.width = '90%';
                        progressText.textContent = 'Upload complete. Analyzing...';
                        resolve();
                    } else {
                        progressFill.style.width = progress + '%';
                        progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                    }
                }, 200);
            });
        }

        function resetForm() {
            analyzeBtn.disabled = false;
            analyzeBtn.querySelector('.btn-text').style.display = 'inline';
            analyzeBtn.querySelector('.btn-loading').style.display = 'none';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
        }

        // ============================================
        // LOAD USAGE & HISTORY
        // ============================================

        function loadUsageAndHistory() {
            // Check user type: 'credits' or 'unlimited'
            const userType = localStorage.getItem('userType') || 'credits';
            const totalCredits = parseInt(localStorage.getItem('totalCredits') || '30');
            const usedCredits = parseInt(localStorage.getItem('analysisUsage') || '0');
            const remainingCredits = Math.max(0, totalCredits - usedCredits);

            const usageMeter = document.getElementById('usageMeter');
            const usageLabel = document.getElementById('usageLabel');
            const usageDisplay = document.getElementById('usageDisplay');
            const usageBar = document.getElementById('usageBar');
            const usageFill = document.getElementById('usageFill');

            if (userType === 'unlimited') {
                // Unlimited subscriber display
                usageLabel.textContent = 'Plan:';
                usageDisplay.innerHTML = '<span class="unlimited-badge">Unlimited</span>';
                usageBar.style.display = 'none';
            } else {
                // Credit-based user display
                usageLabel.textContent = 'Credits remaining:';
                usageDisplay.innerHTML = `<span id="usageCount">${remainingCredits}</span> / ${totalCredits}`;
                usageBar.style.display = 'block';
                usageFill.style.width = (remainingCredits / totalCredits * 100) + '%';

                // Change color when low on credits
                if (remainingCredits <= 5) {
                    usageFill.style.background = '#f59e0b'; // warning orange
                }
                if (remainingCredits === 0) {
                    usageFill.style.background = '#ef4444'; // red
                }
            }

            // Load recent analyses
            const history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            const recentList = document.getElementById('recentAnalyses');

            if (history.length > 0) {
                recentList.innerHTML = history.slice(0, 3).map(item => {
                    const date = new Date(item.timestamp).toLocaleDateString();
                    const drillName = getDrillName(item.drillType);
                    return `<li><strong>${drillName}</strong> - ${item.grade}<br><small>${date}</small></li>`;
                }).join('');
            }
        }

        function getDrillName(type) {
            const names = {
                'dinking': 'Dinking',
                'third-shot-drop': 'Third Shot Drop',
                'speed-up': 'Speed-up',
                'reset': 'Reset',
                'volley': 'Volley',
                'serve': 'Serve',
                'return': 'Return',
                'transition': 'Transition',
                'other': 'Other'
            };
            return names[type] || type;
        }

        // Initialize
        loadUsageAndHistory();
    </script>
</body>
</html>
